<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PAL I Quiz Prep - Sistema de Gest√£o</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            text-align: center;
        }

        .header h1 {
            color: #2d3748;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }

        .header p {
            color: #718096;
            font-size: 1.1rem;
        }

        .nav-tabs {
            background: white;
            border-radius: 12px;
            padding: 8px;
            margin-bottom: 30px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            display: flex;
            gap: 4px;
        }

        .nav-tab {
            flex: 1;
            padding: 12px 20px;
            background: transparent;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.2s;
            color: #718096;
        }

        .nav-tab.active {
            background: #4c51bf;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-4px);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #4c51bf;
            display: block;
        }

        .stat-label {
            color: #718096;
            margin-top: 8px;
            font-size: 0.9rem;
        }

        .controls {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        }

        .controls-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
        }

        .search-box {
            flex: 1;
            min-width: 300px;
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 12px 45px 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.2s;
        }

        .search-box input:focus {
            outline: none;
            border-color: #4c51bf;
        }

        .search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #a0aec0;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: #4c51bf;
            color: white;
        }

        .btn-primary:hover {
            background: #4338ca;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }

        .btn-secondary:hover {
            background: #cbd5e0;
        }

        .btn-success {
            background: #38a169;
            color: white;
        }

        .btn-success:hover {
            background: #2f855a;
        }

        .btn-danger {
            background: #e53e3e;
            color: white;
        }

        .btn-danger:hover {
            background: #c53030;
        }

        .exam-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .exam-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .exam-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #4c51bf, #667eea);
        }

        .exam-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 12px 32px rgba(0,0,0,0.15);
        }

        .exam-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .exam-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 8px;
        }

        .exam-category {
            background: #4c51bf;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .exam-description {
            color: #718096;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .exam-meta {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f7fafc;
            border-radius: 8px;
        }

        .meta-item {
            text-align: center;
        }

        .meta-icon {
            font-size: 1.2rem;
            margin-bottom: 5px;
            display: block;
        }

        .meta-value {
            font-weight: 600;
            color: #2d3748;
            font-size: 1.1rem;
        }

        .meta-label {
            color: #718096;
            font-size: 0.8rem;
        }

        .exam-actions {
            display: flex;
            gap: 10px;
        }

        .exam-actions .btn {
            flex: 1;
            justify-content: center;
            padding: 10px 15px;
            font-size: 14px;
        }

        .form-container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #4a5568;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #4c51bf;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .question-creator {
            border: 2px dashed #e2e8f0;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .question-creator h3 {
            color: #4a5568;
            margin-bottom: 20px;
        }

        .option-input {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .option-input input[type="text"] {
            flex: 1;
        }

        .option-input input[type="radio"] {
            width: auto;
        }

        .questions-list {
            background: #f7fafc;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .question-item {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .question-header {
            font-weight: 600;
            margin-bottom: 10px;
            color: #2d3748;
        }

        .question-text {
            color: #4a5568;
            margin-bottom: 10px;
        }

        .question-options {
            list-style: none;
            margin-bottom: 10px;
        }

        .question-options li {
            padding: 5px 0;
            color: #718096;
        }

        .question-options li.correct {
            color: #38a169;
            font-weight: 600;
        }

        .import-area {
            border: 2px dashed #cbd5e0;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            margin-bottom: 20px;
        }

        .import-area.drag-over {
            border-color: #4c51bf;
            background: #edf2f7;
        }

        .code-preview {
            background: #2d3748;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            overflow-x: auto;
            margin-bottom: 20px;
        }

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #38a169;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
            transform: translateX(400px);
            transition: transform 0.3s;
            z-index: 1000;
        }

        .toast.show {
            transform: translateX(0);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #718096;
        }

        .empty-state h3 {
            margin-bottom: 10px;
            color: #4a5568;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .nav-tabs {
                flex-direction: column;
            }

            .controls-row {
                flex-direction: column;
                align-items: stretch;
            }

            .search-box {
                min-width: auto;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .exam-grid {
                grid-template-columns: 1fr;
            }

            .stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>PAL I Quiz Prep</h1>
            <p>Sistema de Gest√£o de Exames - Professional Agile Leadership</p>
        </div>

        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('dashboard')">üìä Dashboard</button>
            <button class="nav-tab" onclick="showTab('create')">‚ûï Criar Exame</button>
            <button class="nav-tab" onclick="showTab('import')">üì• Importar</button>
            <button class="nav-tab" onclick="showTab('export')">üì§ Exportar</button>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <!-- Stats -->
            <div class="stats">
                <div class="stat-card">
                    <span class="stat-number" id="total-exams">0</span>
                    <div class="stat-label">Total de Exames</div>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="total-questions">0</span>
                    <div class="stat-label">Total de Perguntas</div>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="total-categories">0</span>
                    <div class="stat-label">Categorias</div>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="avg-time">0</span>
                    <div class="stat-label">Minutos M√©dios</div>
                </div>
            </div>

            <!-- Controls -->
            <div class="controls">
                <div class="controls-row">
                    <div class="search-box">
                        <input type="text" id="search-input" placeholder="Pesquisar exames..." onkeyup="filterExams()">
                        <span class="search-icon">üîç</span>
                    </div>
                    <select id="category-filter" onchange="filterExams()">
                        <option value="">Todas as categorias</option>
                    </select>
                    <button class="btn btn-secondary" onclick="clearFilters()">Limpar Filtros</button>
                </div>
                <div class="controls-row">
                    <button class="btn btn-primary" onclick="goToOriginalQuiz()">üéØ Ir para Quiz Original</button>
                    <button class="btn btn-success" onclick="exportBackup()">üíæ Backup JSON</button>
                    <button class="btn btn-secondary" onclick="showStats()">üìà Ver Estat√≠sticas</button>
                </div>
            </div>

            <!-- Exam Grid -->
            <div id="exam-grid" class="exam-grid">
                <!-- Exams will be rendered here -->
            </div>

            <!-- Empty State -->
            <div id="empty-state" class="empty-state" style="display: none;">
                <h3>Nenhum exame encontrado</h3>
                <p>Cria o teu primeiro exame ou importa exames existentes</p>
                <button class="btn btn-primary" onclick="showTab('create')">Criar Primeiro Exame</button>
            </div>
        </div>

        <!-- Create Exam Tab -->
        <div id="create" class="tab-content">
            <div class="form-container">
                <h2>Criar Novo Exame</h2>
                
                <form id="create-exam-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="exam-id">ID do Exame *</label>
                            <input type="text" id="exam-id" placeholder="ex: pal1-mock-2" required>
                        </div>
                        <div class="form-group">
                            <label for="exam-title">T√≠tulo *</label>
                            <input type="text" id="exam-title" placeholder="PAL I Mock Exam #2" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="exam-description">Descri√ß√£o</label>
                        <textarea id="exam-description" placeholder="Descri√ß√£o detalhada do exame..."></textarea>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="exam-time">Dura√ß√£o (minutos)</label>
                            <input type="number" id="exam-time" value="60" min="1">
                        </div>
                        <div class="form-group">
                            <label for="exam-score">Nota M√≠nima (%)</label>
                            <input type="number" id="exam-score" value="85" min="0" max="100">
                        </div>
                    </div>
                </form>

                <!-- Question Creator -->
                <div class="question-creator">
                    <h3>Adicionar Perguntas (<span id="question-count">0</span> criadas)</h3>
                    
                    <div class="form-group">
                        <label for="question-text">Pergunta *</label>
                        <textarea id="question-text" placeholder="Digite a pergunta..."></textarea>
                    </div>

                    <div class="form-group">
                        <label>Op√ß√µes de Resposta *</label>
                        <div id="options-container">
                            <div class="option-input">
                                <input type="text" placeholder="Op√ß√£o 1" class="option-text">
                                <input type="radio" name="correct-option" value="0" checked>
                                <label>Correta</label>
                            </div>
                            <div class="option-input">
                                <input type="text" placeholder="Op√ß√£o 2" class="option-text">
                                <input type="radio" name="correct-option" value="1">
                                <label>Correta</label>
                            </div>
                        </div>
                        <button type="button" class="btn btn-secondary" onclick="addOption()">+ Adicionar Op√ß√£o</button>
                    </div>

                    <div class="form-group">
                        <label for="question-explanation">Explica√ß√£o *</label>
                        <textarea id="question-explanation" placeholder="Explica√ß√£o detalhada da resposta correta..."></textarea>
                    </div>

                    <button type="button" class="btn btn-primary" onclick="addQuestion()">Adicionar Pergunta</button>
                </div>

                <!-- Questions List -->
                <div id="questions-list" class="questions-list" style="display: none;">
                    <h3>Perguntas do Exame</h3>
                    <div id="questions-container"></div>
                </div>

                <!-- Create Button -->
                <div style="text-align: center; margin-top: 30px;">
                    <button type="button" class="btn btn-success" onclick="createExam()" style="padding: 15px 40px; font-size: 18px;">
                        üöÄ Criar Exame
                    </button>
                </div>
            </div>
        </div>

        <!-- Import Tab -->
        <div id="import" class="tab-content">
            <div class="form-container">
                <h2>Importar Exames</h2>

                <div class="form-group">
                    <label>Modo de Importa√ß√£o</label>
                    <div style="display: flex; gap: 20px; margin-top: 10px;">
                        <label>
                            <input type="radio" name="import-mode" value="merge" checked>
                            Adicionar aos existentes
                        </label>
                        <label>
                            <input type="radio" name="import-mode" value="replace">
                            Substituir todos
                        </label>
                    </div>
                </div>

                <div class="import-area" id="import-area">
                    <h3>üìÅ Arrastar ficheiro JSON aqui</h3>
                    <p>ou</p>
                    <input type="file" id="file-input" accept=".json,.js" style="display: none;" onchange="handleFileUpload(event)">
                    <button class="btn btn-primary" onclick="document.getElementById('file-input').click()">
                        Escolher Ficheiro
                    </button>
                </div>

                <div class="form-group">
                    <label for="import-text">Ou cola o teu c√≥digo aqui:</label>
                    <textarea id="import-text" placeholder="Cola aqui o teu array mockExams ou JSON..." rows="10"></textarea>
                </div>

                <button class="btn btn-success" onclick="importExams()">Importar Exames</button>

                <div style="margin-top: 30px; padding: 20px; background: #edf2f7; border-radius: 8px;">
                    <h4>üîß Como Importar os Teus Exames Existentes:</h4>
                    <ol style="margin-left: 20px; margin-top: 10px;">
                        <li>Vai ao teu ficheiro atual com o array <code>mockExams</code></li>
                        <li>Copia todo o array (desde <code>[</code> at√© <code>]</code>)</li>
                        <li>Cola na caixa de texto acima</li>
                        <li>Clica "Importar Exames"</li>
                    </ol>
                </div>
            </div>
        </div>

        <!-- Export Tab -->
        <div id="export" class="tab-content">
            <div class="form-container">
                <h2>Exportar Exames</h2>

                <div class="form-group">
                    <h3>Op√ß√µes de Exporta√ß√£o</h3>
                    <div style="display: flex; gap: 15px; margin: 20px 0; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="exportAsJSON()">üìÑ Exportar JSON</button>
                        <button class="btn btn-secondary" onclick="exportAsJS()">üìù Exportar JavaScript</button>
                        <button class="btn btn-success" onclick="exportAsHTML()">üåê Exportar HTML Completo</button>
                    </div>
                </div>

                <div class="form-group">
                    <label>Preview do C√≥digo:</label>
                    <div id="export-preview" class="code-preview">
                        // O c√≥digo ser√° gerado aqui...
                    </div>
                </div>

                <div style="background: #f7fafc; padding: 20px; border-radius: 8px; margin-top: 20px;">
                    <h4>üìã Formatos de Exporta√ß√£o:</h4>
                    <ul style="margin-left: 20px; margin-top: 10px;">
                        <li><strong>JSON:</strong> Para backup ou importa√ß√£o noutras ferramentas</li>
                        <li><strong>JavaScript:</strong> Array mockExams para usar no teu c√≥digo</li>
                        <li><strong>HTML:</strong> P√°gina completa com todos os exames integrados</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <script>
        // Data Storage
        let exams = [];
        let currentQuestions = [];

        // Initialize App
        document.addEventListener('DOMContentLoaded', function() {
            loadExams();
            updateStats();
            renderExams();
            updateCategories();
            
            // Setup drag and drop
            setupDragAndDrop();
        });

        // Exam Management
        function loadExams() {
            const saved = localStorage.getItem('pal-i-exams');
            if (saved) {
                try {
                    exams = JSON.parse(saved);
                } catch (e) {
                    console.error('Error loading saved exams:', e);
                    exams = [];
                }
            }
        }

        function saveExams() {
            localStorage.setItem('pal-i-exams', JSON.stringify(exams));
            updateStats();
            renderExams();
            updateCategories();
        }

        // Tab Management
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            // Update export preview if export tab
            if (tabName === 'export') {
                updateExportPreview();
            }
        }

        // Stats Update
        function updateStats() {
            const totalExams = exams.length;
            const totalQuestions = exams.reduce((sum, exam) => sum + exam.questions.length, 0);
            const categories = [...new Set(exams.map(exam => exam.id.split('-')[0]))].length;
            const avgTime = totalExams > 0 ? Math.round(exams.reduce((sum, exam) => sum + exam.timeLimit, 0) / totalExams) : 0;

            document.getElementById('total-exams').textContent = totalExams;
            document.getElementById('total-questions').textContent = totalQuestions;
            document.getElementById('total-categories').textContent = categories;
            document.getElementById('avg-time').textContent = avgTime;
        }

        // Render Exams
        function renderExams() {
            const grid = document.getElementById('exam-grid');
            const emptyState = document.getElementById('empty-state');
            
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const categoryFilter = document.getElementById('category-filter').value.toLowerCase();

            let filteredExams = exams.filter(exam => {
                const matchesSearch = exam.title.toLowerCase().includes(searchTerm) ||
                                    exam.description.toLowerCase().includes(searchTerm) ||
                                    exam.id.toLowerCase().includes(searchTerm);
                
                const matchesCategory = !categoryFilter || 
                                      exam.id.toLowerCase().includes(categoryFilter);
                
                return matchesSearch && matchesCategory;
            });

            if (filteredExams.length === 0) {
                grid.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            grid.style.display = 'grid';
            emptyState.style.display = 'none';

            grid.innerHTML = filteredExams.map(exam => `
                <div class="exam-card">
                    <div class="exam-header">
                        <div>
                            <div class="exam-title">${exam.title}</div>
                            <div class="exam-category">${exam.id.split('-')[0].toUpperCase()}</div>
                        </div>
                    </div>
                    
                    <div class="exam-description">${exam.description}</div>
                    
                    <div class="exam-meta">
                        <div class="meta-item">
                            <span class="meta-icon">‚è∞</span>
                            <div class="meta-value">${exam.timeLimit}</div>
                            <div class="meta-label">minutos</div>
                        </div>
                        <div class="meta-item">
                            <span class="meta-icon">üéØ</span>
                            <div class="meta-value">${exam.passingScore}%</div>
                            <div class="meta-label">m√≠nima</div>
                        </div>
                        <div class="meta-item">
                            <span class="meta-icon">‚ùì</span>
                            <div class="meta-value">${exam.questions.length}</div>
                            <div class="meta-label">perguntas</div>
                        </div>
                    </div>
                    
                    <div class="exam-actions">
                        <button class="btn btn-primary" onclick="startExam('${exam.id}')">üöÄ Iniciar</button>
                        <button class="btn btn-secondary" onclick="previewExam('${exam.id}')">üëÅÔ∏è Ver</button>
                        <button class="btn btn-danger" onclick="deleteExam('${exam.id}')">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
        }

        // Update Categories Filter
        function updateCategories() {
            const select = document.getElementById('category-filter');
            const categories = [...new Set(exams.map(exam => exam.id.split('-')[0]))];
            
            select.innerHTML = '<option value="">Todas as categorias</option>' +
                categories.map(cat => `<option value="${cat.toLowerCase()}">${cat.toUpperCase()}</option>`).join('');
        }

        // Filter Functions
        function filterExams() {
            renderExams();
        }

        function clearFilters() {
            document.getElementById('search-input').value = '';
            document.getElementById('category-filter').value = '';
            renderExams();
        }

        // Question Management for Creation
        function addOption() {
            const container = document.getElementById('options-container');
            const optionCount = container.children.length;
            
            const optionDiv = document.createElement('div');
            optionDiv.className = 'option-input';
            optionDiv.innerHTML = `
                <input type="text" placeholder="Op√ß√£o ${optionCount + 1}" class="option-text">
                <input type="radio" name="correct-option" value="${optionCount}">
                <label>Correta</label>
                <button type="button" onclick="removeOption(this)" class="btn btn-danger" style="padding: 5px;">‚ùå</button>
            `;
            
            container.appendChild(optionDiv);
        }

        function removeOption(button) {
            const container = document.getElementById('options-container');
            if (container.children.length > 2) {
                button.parentElement.remove();
                // Update radio button values
                Array.from(container.children).forEach((div, index) => {
                    const radio = div.querySelector('input[type="radio"]');
                    radio.value = index;
                });
            } else {
                showToast('Deve ter pelo menos 2 op√ß√µes', 'error');
            }
        }

        function addQuestion() {
            const questionText = document.getElementById('question-text').value.trim();
            const explanation = document.getElementById('question-explanation').value.trim();
            const optionInputs = document.querySelectorAll('.option-text');
            const correctOption = document.querySelector('input[name="correct-option"]:checked');

            if (!questionText) {
                showToast('Por favor, preenche a pergunta', 'error');
                return;
            }

            if (!explanation) {
                showToast('Por favor, preenche a explica√ß√£o', 'error');
                return;
            }

            const options = Array.from(optionInputs)
                .map(input => input.value.trim())
                .filter(opt => opt);

            if (options.length < 2) {
                showToast('Adiciona pelo menos 2 op√ß√µes', 'error');
                return;
            }

            const question = {
                id: `q${currentQuestions.length + 1}`,
                question: questionText,
                options: options,
                correctAnswer: parseInt(correctOption.value),
                explanation: explanation
            };

            currentQuestions.push(question);
            updateQuestionsList();
            clearQuestionForm();
            showToast('Pergunta adicionada com sucesso!', 'success');
        }

        function updateQuestionsList() {
            const count = document.getElementById('question-count');
            const list = document.getElementById('questions-list');
            const container = document.getElementById('questions-container');

            count.textContent = currentQuestions.length;

            if (currentQuestions.length > 0) {
                list.style.display = 'block';
                container.innerHTML = currentQuestions.map((q, index) => `
                    <div class="question-item">
                        <div class="question-header">Pergunta ${index + 1}</div>
                        <div class="question-text">${q.question}</div>
                        <ul class="question-options">
                            ${q.options.map((opt, optIndex) => `
                                <li class="${optIndex === q.correctAnswer ? 'correct' : ''}">
                                    ${opt} ${optIndex === q.correctAnswer ? '‚úì' : ''}
                                </li>
                            `).join('')}
                        </ul>
                        <div style="font-size: 0.9em; color: #718096;">
                            <strong>Explica√ß√£o:</strong> ${q.explanation}
                        </div>
                        <button class="btn btn-danger" onclick="removeQuestion(${index})" style="margin-top: 10px; padding: 5px 10px;">
                            Remover Pergunta
                        </button>
                    </div>
                `).join('');
            } else {
                list.style.display = 'none';
            }
        }

        function removeQuestion(index) {
            currentQuestions.splice(index, 1);
            updateQuestionsList();
            showToast('Pergunta removida', 'info');
        }

        function clearQuestionForm() {
            document.getElementById('question-text').value = '';
            document.getElementById('question-explanation').value = '';
            document.querySelectorAll('.option-text').forEach(input => input.value = '');
            document.querySelector('input[name="correct-option"]:checked').checked = true;
        }

        // Create Exam
        function createExam() {
            const id = document.getElementById('exam-id').value.trim();
            const title = document.getElementById('exam-title').value.trim();
            const description = document.getElementById('exam-description').value.trim();
            const timeLimit = parseInt(document.getElementById('exam-time').value);
            const passingScore = parseInt(document.getElementById('exam-score').value);

            if (!id || !title) {
                showToast('Por favor, preenche os campos obrigat√≥rios', 'error');
                return;
            }

            if (currentQuestions.length === 0) {
                showToast('Adiciona pelo menos uma pergunta', 'error');
                return;
            }

            // Check if exam ID already exists
            if (exams.find(exam => exam.id === id)) {
                showToast('J√° existe um exame com esse ID', 'error');
                return;
            }

            // Update question IDs to include exam ID
            const questions = currentQuestions.map((q, index) => ({
                ...q,
                id: `${id}_q${index + 1}`
            }));

            const newExam = {
                id,
                title,
                description,
                timeLimit,
                passingScore,
                questions
            };

            exams.push(newExam);
            saveExams();

            // Reset form
            document.getElementById('create-exam-form').reset();
            currentQuestions = [];
            updateQuestionsList();
            
            showToast(`Exame "${title}" criado com sucesso!`, 'success');
            showTab('dashboard');
        }

        // Import Functions
        function setupDragAndDrop() {
            const importArea = document.getElementById('import-area');
            
            importArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                importArea.classList.add('drag-over');
            });

            importArea.addEventListener('dragleave', () => {
                importArea.classList.remove('drag-over');
            });

            importArea.addEventListener('drop', (e) => {
                e.preventDefault();
                importArea.classList.remove('drag-over');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileUpload({ target: { files } });
                }
            });
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('import-text').value = e.target.result;
            };
            reader.readAsText(file);
        }

        function importExams() {
            const importText = document.getElementById('import-text').value.trim();
            const mode = document.querySelector('input[name="import-mode"]:checked').value;

            if (!importText) {
                showToast('Por favor, cola o c√≥digo ou escolhe um ficheiro', 'error');
                return;
            }

            try {
                let importedData;
                
                // Try to parse as JSON first
                try {
                    importedData = JSON.parse(importText);
                } catch {
                    // If not JSON, try to extract array from JavaScript code
                    const arrayMatch = importText.match(/\[[\s\S]*\]/);
                    if (arrayMatch) {
                        importedData = JSON.parse(arrayMatch[0]);
                    } else {
                        throw new Error('Invalid format');
                    }
                }

                if (!Array.isArray(importedData)) {
                    throw new Error('Data must be an array');
                }

                // Validate exam structure
                const validExams = importedData.filter(exam => {
                    return exam.id && exam.title && exam.questions && Array.isArray(exam.questions);
                });

                if (validExams.length === 0) {
                    throw new Error('No valid exams found');
                }

                if (mode === 'replace') {
                    exams = validExams;
                } else {
                    // Merge mode - avoid duplicates
                    const existingIds = exams.map(e => e.id);
                    const newExams = validExams.filter(e => !existingIds.includes(e.id));
                    exams = [...exams, ...newExams];
                }

                saveExams();
                document.getElementById('import-text').value = '';
                
                showToast(`Importados ${validExams.length} exames com sucesso!`, 'success');
                showTab('dashboard');

            } catch (error) {
                showToast(`Erro ao importar: ${error.message}`, 'error');
            }
        }

        // Export Functions
        function updateExportPreview() {
            const preview = document.getElementById('export-preview');
            const code = `// PAL I Exams - Exportado em ${new Date().toLocaleDateString()}
const mockExams = ${JSON.stringify(exams, null, 2)};

export default mockExams;`;
            
            preview.textContent = code;
        }

        function exportAsJSON() {
            const dataStr = JSON.stringify(exams, null, 2);
            downloadFile(dataStr, 'pal-i-exams-backup.json', 'application/json');
            showToast('Backup JSON exportado!', 'success');
        }

        function exportAsJS() {
            const code = `// PAL I Exams - Exportado em ${new Date().toLocaleDateString()}
export const mockExams = ${JSON.stringify(exams, null, 2)};`;
            
            downloadFile(code, 'mockExams.js', 'application/javascript');
            showToast('JavaScript exportado!', 'success');
        }

        function exportAsHTML() {
            const htmlTemplate = `<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PAL I Quiz Prep - Exames</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        .exam-card { background: white; border-radius: 8px; padding: 20px; margin: 20px 0; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .exam-title { color: #333; font-size: 1.5em; margin-bottom: 10px; }
        .exam-meta { color: #666; margin-bottom: 15px; }
        .question { margin: 15px 0; padding: 15px; background: #f9f9f9; border-radius: 5px; }
        .options { list-style: none; padding: 0; }
        .options li { padding: 5px 0; }
        .correct { color: #28a745; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>PAL I Quiz Prep - Todos os Exames</h1>
        <p>Exportado em ${new Date().toLocaleDateString()} √†s ${new Date().toLocaleTimeString()}</p>
        
        ${exams.map(exam => `
            <div class="exam-card">
                <h2 class="exam-title">${exam.title}</h2>
                <div class="exam-meta">
                    ID: ${exam.id} | Dura√ß√£o: ${exam.timeLimit}min | Nota m√≠nima: ${exam.passingScore}% | 
                    ${exam.questions.length} perguntas
                </div>
                <p>${exam.description}</p>
                
                ${exam.questions.map((q, index) => `
                    <div class="question">
                        <h4>Pergunta ${index + 1}</h4>
                        <p><strong>${q.question}</strong></p>
                        <ul class="options">
                            ${q.options.map((opt, optIndex) => `
                                <li class="${optIndex === q.correctAnswer ? 'correct' : ''}">
                                    ${opt} ${optIndex === q.correctAnswer ? '‚úì' : ''}
                                </li>
                            `).join('')}
                        </ul>
                        <p><strong>Explica√ß√£o:</strong> ${q.explanation}</p>
                    </div>
                `).join('')}
            </div>
        `).join('')}
    </div>
</body>
</html>`;

            downloadFile(htmlTemplate, 'pal-i-exams-complete.html', 'text/html');
            showToast('HTML completo exportado!', 'success');
        }

        function exportBackup() {
            exportAsJSON();
        }

        // Utility Functions
        function downloadFile(content, filename, contentType) {
            const blob = new Blob([content], { type: contentType });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type}`;
            toast.classList.add('show');

            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Exam Actions
        function startExam(examId) {
            // Redirect to original quiz with specific exam
            const exam = exams.find(e => e.id === examId);
            if (exam) {
                // Store selected exam for the quiz page
                localStorage.setItem('selected-exam', JSON.stringify(exam));
                
                // If you have a quiz.html page, redirect there
                // window.location.href = 'quiz.html';
                
                // For now, show a preview
                previewExam(examId);
            }
        }

        function previewExam(examId) {
            const exam = exams.find(e => e.id === examId);
            if (exam) {
                const preview = `
**${exam.title}**
${exam.description}

Dura√ß√£o: ${exam.timeLimit} minutos
Nota m√≠nima: ${exam.passingScore}%
Total de perguntas: ${exam.questions.length}

Primeiras 3 perguntas:
${exam.questions.slice(0, 3).map((q, i) => `
${i + 1}. ${q.question}
${q.options.map((opt, j) => `   ${String.fromCharCode(97 + j)}) ${opt}`).join('\n')}
Resposta: ${String.fromCharCode(97 + q.correctAnswer)}) ${q.options[q.correctAnswer]}
`).join('\n')}
                `;
                
                alert(preview);
            }
        }

        function deleteExam(examId) {
            if (confirm('Tens a certeza que queres eliminar este exame?')) {
                exams = exams.filter(e => e.id !== examId);
                saveExams();
                showToast('Exame eliminado', 'info');
            }
        }

        function goToOriginalQuiz() {
            // Export all exams and provide instructions
            const code = `// Cola este c√≥digo no teu ficheiro mockExams.js original
export const mockExams = ${JSON.stringify(exams, null, 2)};`;
            
            const newWindow = window.open('', '_blank');
            newWindow.document.write(`
                <html>
                <head><title>C√≥digo para Integra√ß√£o</title></head>
                <body style="font-family: Arial, sans-serif; padding: 20px;">
                    <h2>C√≥digo para o teu Quiz Original</h2>
                    <p>Copia este c√≥digo e cola no teu ficheiro JavaScript:</p>
                    <pre style="background: #f4f4f4; padding: 15px; overflow-x: auto;">${code}</pre>
                    <button onclick="navigator.clipboard.writeText(\`${code.replace(/`/g, '\\`')}\`)">
                        Copiar C√≥digo
                    </button>
                </body>
                </html>
            `);
        }

        function showStats() {
            const categories = {};
            exams.forEach(exam => {
                const category = exam.id.split('-')[0].toUpperCase();
                if (!categories[category]) {
                    categories[category] = {
                        count: 0,
                        totalQuestions: 0,
                        avgTime: 0,
                        avgScore: 0
                    };
                }
                categories[category].count++;
                categories[category].totalQuestions += exam.questions.length;
                categories[category].avgTime += exam.timeLimit;
                categories[category].avgScore += exam.passingScore;
            });

            Object.keys(categories).forEach(cat => {
                const data = categories[cat];
                data.avgTime = Math.round(data.avgTime / data.count);
                data.avgScore = Math.round(data.avgScore / data.count);
            });

            const statsHTML = `
                <h3>üìä Estat√≠sticas Detalhadas</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    ${Object.entries(categories).map(([cat, data]) => `
                        <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <h4 style="color: #4c51bf; margin-bottom: 10px;">${cat}</h4>
                            <p><strong>${data.count}</strong> exames</p>
                            <p><strong>${data.totalQuestions}</strong> perguntas totais</p>
                            <p><strong>${data.avgTime}</strong> min. m√©dios</p>
                            <p><strong>${data.avgScore}%</strong> nota m√©dia</p>
                        </div>
                    `).join('')}
                </div>
            `;

            const newWindow = window.open('', '_blank', 'width=800,height=600');
            newWindow.document.write(`
                <html>
                <head>
                    <title>Estat√≠sticas dos Exames</title>
                    <style>body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }</style>
                </head>
                <body>${statsHTML}</body>
                </html>
            `);
        }
    </script>
</body>
</html>
